<!DOCTYPE HTML>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>Vaultage 2.0</title>
    <meta name="author" content="Ludovic Barman"/>
    <meta name="Description" content="An online password manager with local encryption."/>
    <script src="./js/jquery-1.7.1.min.js"></script>
    <script src="./js/jquery.mousewheel-min.js"></script>
    <script src="./js/jquery.terminal-min.js"></script>
    <script src="./lib/cryptojs.core.min.js"></script>
    <script src="./lib/cryptojs.enc-utf16.min.js"></script>
    <script src="./lib/cryptojs.enc-base64.min.js"></script>
    <script src="./lib/cryptojs.sha1.min.js"></script>
    <script src="./lib/cryptojs.aes.min.js"></script>
    <script src="./lib/jquery.base64.js"></script>
    <script src="./lib/underscore-min.js"></script>
    <script src="./lib/js.cookie.js"></script>
    <script src="./lib/pwdGen.js"></script>
    <link href="./css/jquery.terminal.css" rel="stylesheet"/>
    <link href="./css/main.css" rel="stylesheet"/>
  </head>
<body>

<script>
globalKeyUpValue = "";
jQuery(document).ready(function($) {
    var id = 1;

    $('body').terminal(function(command, term) {
        if (command == 'auth') {

            term.push(function(user, term) {
                term.set_mask('*').push(function(remotePass) {
                    term.set_mask('*').push(function(localPass) {

                        _localPasswordSha1 = CryptoJS.SHA1(localPass);
                        var _localPasswordHash = _localPasswordSha1.toString(CryptoJS.enc.Base64);

                        _remotePasswordSha1 = CryptoJS.SHA1(remotePass);
                        var _remotePasswordHash = _remotePasswordSha1.toString(CryptoJS.enc.Base64);

                        getCipher(user, _localPasswordHash, _remotePasswordHash, term);
                        term.pop().set_mask(false);
                        term.pop().set_mask(false);
                        term.pop();
                    }, {
                        prompt: 'local password: '
                    });
                }, {
                    prompt: 'remote password: '
                });
            }, {
                name: 'auth',
                prompt: 'user : '
            });

        } else if (command.lastIndexOf("get", 0) === 0) {

            var searchKeys = command.replace("get ", "").toLowerCase();
            if (!isAuth) {
                term.echo("You should <i>auth</i> first.");
            } else if (searchKeys == "" || searchKeys == "get") {
                term.echo("Syntax : <i>get</i> SEARCH_TERM");
            } else {

                if (notes.length == 0) {
                    term.echo("You have 0 entries. You should <i>pull</i> entries, or use <i>new</i>, <i>gen</i>.");
                }
                var op = "and"

                if (searchKeys.lastIndexOf("-or ", 0) === 0) {
                    op = "or"
                    searchKeys = searchKeys.replace("-or ", "")
                }


                var searchKeysParts = searchKeys.split(" ")

                var searchString = []
                var i = 1
                 _.each(searchKeysParts, function(searchKey) {
                    searchString.push('<span class="highlight'+i+'">' + searchKey + '</span>')
                    i++
                 });

                if (op == "and") {
                    term.echo("Searching for " + searchString.join(" AND ") + "");
                }else{
                    term.echo("Searching for " + searchString.join(" OR ") + "");
                }

                var filtered = _.filter(notes, function(el) {
                    var id = (el.id == undefined) ? '' : ("" + el.id).toLowerCase();
                    var title = (el.title == undefined) ? '' : el.title.toLowerCase();
                    var url = (el.url == undefined) ? '' : el.url.toLowerCase();
                    var login = (el.login == undefined) ? '' : el.login.toLowerCase();

                    if (op == "or") {
                        var matchedOne = false

                        _.each(searchKeysParts, function(searchKey){
                          var s = searchKey.toLowerCase().trim()
                          matchedOne = matchedOne || (id.indexOf(s) != -1) || (title.indexOf(s) != -1) || (url.indexOf(s) != -1) || (login.indexOf(s) != -1);
                        })

                        return matchedOne;
                    } else {
                        //op == "and"
                        var matchedAll = true

                        _.each(searchKeysParts, function(searchKey){
                          var s = searchKey.toLowerCase().trim()
                          matchedAll = matchedAll && ((id.indexOf(s) != -1) || (title.indexOf(s) != -1) || (url.indexOf(s) != -1) || (login.indexOf(s) != -1));
                        })

                        return matchedAll;
                    }
                });

                //this could be done in one step with the above function
                var sorted = _.sortBy(filtered, function(el) { 
                    var id = (el.id == undefined) ? '' : ("" + el.id).toLowerCase();
                    var title = (el.title == undefined) ? '' : el.title.toLowerCase();
                    var url = (el.url == undefined) ? '' : el.url.toLowerCase();
                    var login = (el.login == undefined) ? '' : el.login.toLowerCase();

                    var numMatched = 0

                    _.each(searchKeysParts, function(searchKey){
                      var s = searchKey.toLowerCase().trim()

                      numMatched += countOccurrences(id, s, false)
                      numMatched += countOccurrences(title, s, false)
                      numMatched += countOccurrences(url, s, false)
                      numMatched += countOccurrences(login, s, false)
                    });

                    return 1000 - numMatched; //ugly trick to reverse the order easily
                } );

                _.each(sorted, function(obj) {

                    var _id = highlight(searchKeysParts, "" + obj.id)
                    var _title = highlight(searchKeysParts, obj.title)
                    var _login = highlight(searchKeysParts, obj.login)
                    var _url = highlight(searchKeysParts, obj.url)
                    var _pwd = highlight(searchKeysParts, obj.content)


                    var s = '<span class="entry"><span class="id">(' +_id + ')</span> <span class="title">' + _title + "</span> -> <span class=\"login\">" + _login + "</span> @ <span class=\"url\">" + _url + "</span> : <span class=\"content\">" + _pwd + "</span></span>";

                    term.echo(s)
                })

                //blur after 30 sec
                setTimeout( function(){ 
                    $(".content").addClass("blurred")
                  }, 10000);
            }

        } else if (command.lastIndexOf("rm", 0) === 0) {

            if (!isAuth) {
                term.echo("You should <i>auth</i> first.");
            } else {
                var searchKey = command.replace("rm ", "").toLowerCase();
                term.echo("Removing ID \"" + searchKey + "\"");

                var filtered = _.filter(notes, function(el) {
                    var id = (el.id == undefined) ? '' : (el.id + '');
                    return (id.indexOf(searchKey) != -1);
                });

                _.each(filtered, function(obj) {
                    term.echo('Entry ' + obj.id + ' found : ' + obj.title + " -> " + obj.login + " @ " + obj.url + " : " + obj.content)

                    newNotes = _.filter(notes, function(el) {
                        return (el.id != searchKey);
                    });

                    term.echo('Going to remove ' + (notes.length - newNotes.length) + ' entries.')

                    var history = term.history();
                    history.disable();
                    term.push(function(command) {
                        if (command.match(/^(y|yes)$/i)) {

                            oldNotesLength = notes.length;
                            oldHash = hash(JSON.stringify(notes));

                            notes = newNotes;
                            saveCipher(oldNotesLength, oldHash, false, term);

                            term.pop();
                            history.enable();
                        } else if (command.match(/^(n|no)$/i)) {
                            term.pop();
                            history.enable();
                        }
                    }, {
                        prompt: 'Are you sure? '
                    });

                })
            }

        } else if (command == "gen") {

            if (!isAuth) {
                term.echo("You should <i>auth</i> first.");
            } else {
                term.push(function(title, term) {
                    term.push(function(login, term) {
                        term.push(function(url, term) {
                            genEntry(title, login, url, term);
                            term.pop();
                            term.pop();
                            term.pop();
                        }, {
                            name: 'gen',
                            prompt: 'url : '
                        });
                    }, {
                        name: 'gen',
                        prompt: 'login : '
                    });
                }, {
                    name: 'gen',
                    prompt: 'title : '
                });
            }


        } else if (command == "new") {

            if (!isAuth) {
                term.echo("You should <i>auth</i> first.");
            } else {
                term.push(function(title, term) {
                    term.push(function(login, term) {
                        term.push(function(url, term) {
                            term.push(function(pwd, term) {
                                addEntry(title, login, url, pwd, term);
                                term.pop();
                                term.pop();
                                term.pop();
                                term.pop();
                            }, {
                                name: 'new',
                                prompt: 'password : '
                            });
                        }, {
                            name: 'new',
                            prompt: 'url : '
                        });
                    }, {
                        name: 'new',
                        prompt: 'login : '
                    });
                }, {
                    name: 'new',
                    prompt: 'title : '
                });
            }

        } else if (command.lastIndexOf("edit", 0) === 0) {

            if (!isAuth) {
                term.echo("You should <i>auth</i> first.");
            } else {
                var searchKey = command.replace("edit ", "").toLowerCase();

                var filtered = _.filter(notes, function(el) {
                    var id = (el.id == undefined) ? '' : (el.id + '');
                    return (id.indexOf(searchKey) != -1);
                });

                if(filtered.length == 0)
                {
                    term.echo("Could not find this ID")
                }
                else
                {
                    var s = '<span class="entry"><span class="id">(' + filtered[0].id + ')</span> <span class="title">' + filtered[0].title + "</span> -> <span class=\"login\">" + filtered[0].login + "</span> @ <span class=\"url\">" + filtered[0].url + "</span> : <span class=\"content\">" + filtered[0].content + "</span></span>";

                    term.echo("Going to edit the following entry :");
                    term.echo(s);

                    term.echo("Use KEY UP to edit the previous text, KEY DOWN to clear.");
                    
                    globalKeyUpValue = filtered[0].title;

                    term.push(function(title, term) {

                        globalKeyUpValue = filtered[0].login;

                        term.push(function(login, term) {

                            globalKeyUpValue = filtered[0].url;

                            term.push(function(url, term) {

                                globalKeyUpValue = filtered[0].content;

                                term.push(function(pwd, term) {

                                    globalKeyUpValue = "";

                                    editEntry(filtered[0].id, title, login, url, pwd, term)

                                    var s = '<span class="entry"><span class="id">(' + filtered[0].id + ')</span> <span class="title">' + filtered[0].title + "</span> -> <span class=\"login\">" + filtered[0].login + "</span> @ <span class=\"url\">" + filtered[0].url + "</span> : <span class=\"content\">" + filtered[0].content + "</span></span>";

                                    term.echo("The entry #"+filtered[0].id+" is now :");
                                    term.echo(s);

                                    term.pop();
                                    term.pop();
                                    term.pop();
                                    term.pop();
                                }, {
                                    name: 'edit',
                                    prompt: 'new password : '
                                });
                            }, {
                                name: 'edit',
                                prompt: 'new url : '
                            });
                        }, {
                            name: 'edit',
                            prompt: 'new login : '
                        });
                    }, {
                        name: 'edit',
                        prompt: 'new title : '
                    });
                }
            }

        } else if (command == "push --force") {

            if (!isAuth) {
                term.echo("You should <i>auth</i> first.");
            } else {
                saveCipher(notes.length, hash(JSON.stringify(notes)), true, term);
            }

        } else if (command == "push") {

            if (!isAuth) {
                term.echo("You should <i>auth</i> first.");
            } else {
                saveCipher(notes.length, hash(JSON.stringify(notes)), false, term);
            }

        } else if (command == "pull") {

            if (!isAuth) {
                term.echo("You should <i>auth</i> first.");
            } else {
                getCipher(username, localPassword, remotePassword, term);
            }

        } else if (command == "saveauth") {

            if (!isAuth) {
                term.echo("You should <i>auth</i> first.");
            } else {
                Cookies.set('username', username, {
                    expires: 7
                });
                Cookies.set('remotePassword', remotePassword, {
                    expires: 7
                });
            }

        } else if (command == "pwd") {

            if (!isAuth) {
                term.echo("You should <i>auth</i> first.");
            } else {
                term.set_mask('*').push(function(localPass1) {
                    term.set_mask('*').push(function(localPass2) {

                        if (localPass1 == localPass2) {
                            term.echo("Changing local password... ");
                            saveCipher(notes.length, hash(JSON.stringify(notes)), false, term);
                            term.echo("New local password saved.");
                        } else {
                            term.echo("Passwords don't match, aborting.");
                        }
                        term.pop().set_mask(false);
                        term.pop().set_mask(false);
                    }, {
                        prompt: 'new local password (repeat): '
                    });
                }, {
                    prompt: 'new local password: '
                });
            }

        } else if (command == "loadauth") {

            if (Cookies.get('username') == undefined || Cookies.get('remotePassword') == undefined) {
                term.echo("Could not load cookies, please re-auth.");
            } else {
                username = Cookies.get('username')
                remotePassword = Cookies.get('remotePassword')
                term.set_mask('*').push(function(localPass) {

                    _localPasswordSha1 = CryptoJS.SHA1(localPass);
                    localPassword = _localPasswordSha1.toString(CryptoJS.enc.Base64);
                    isAuth = true;

                    //automatic pull
                    getCipher(username, localPassword, remotePassword, term)

                    term.pop().set_mask(false);
                }, {
                    prompt: 'local password: '
                });
            }

        } else if (command == "clear") {

            term.echo("available commands : <i>auth</i>, <i>get TERM</i>, <i>gen</i>, <i>edit ID</i>, <i>rm ID</i>, <i>push</i>, <i>pull</i>, <i>clear</i>, <i>logout</i>, <i>saveauth</i>, <i>loadauth</i>, <i>clearauth</i>.")

        } else if (command == "logout") {

            username = ""
            remotePassword = ""
            localPassword = ""
            isAuth = false

        } else if (command == "clearauth") {

            Cookies.remove('username');
            Cookies.remove('remotePassword');

        } else if (command == 'help') {
            term.echo("available commands : <i>auth</i>, <i>get TERM</i>, <i>new</i>, <i>edit ID</i>, <i>gen</i>, <i>rm ID</i>, <i>push</i>, <i>pull</i>, <i>clear</i>, <i>logout</i>, <i>saveauth</i>, <i>loadauth</i>, <i>clearauth</i>.")

        } else {
            term.echo('unknow command "' + command + '"');
            term.echo("available commands : <i>auth</i>, <i>get TERM</i>, <i>new</i>, <i>gen</i>, <i>edit ID</i>, <i>rm ID</i>, <i>push</i>, <i>pull</i>, <i>clear</i>, <i>logout</i>, <i>saveauth</i>, <i>loadauth</i>, <i>clearauth</i>.")
        }
    }, {
        greetings: "Vaultage v2.0 <br />*************<br />available commands : <i>auth</i>, <i>get TERM</i>, <i>new</i>, <i>gen</i>, <i>edit ID</i>, <i>rm ID</i>, <i>push</i>, <i>pull</i>, <i>clear</i>, <i>logout</i>, <i>saveauth</i>, <i>loadauth</i>, <i>clearauth</i>.<br />",
        onBlur: function() {
            // prevent loosing focus
            return false;
        }
    });
});

var isAuth = false;
var notes = [];
var username = ""
var remotePassword = ""
var localPassword = ""


function editEntry(id, title, login, url, pwd, term) {

    var index = 0;

    while (index < notes.length) {
        var nodeId = (notes[index].id == undefined) ? '' : (notes[index].id + '');
        if(nodeId == id)
        {
            break;
        }
        index++
    }

    if(notes[index] == id)
    {
        term.echo("WARNING: editEntry did nothing, ID not found")
    }

    oldHash = hash(JSON.stringify(notes));

    notes[index].title = title;
    notes[index].login = login;
    notes[index].url = url;
    notes[index].content = pwd;

    saveCipher(notes.length, oldHash, false, term);


    var s = '<span class="entry"><span class="id">(' + notes[index].id + ')</span> <span class="title">' + notes[index].title + "</span> -> <span class=\"login\">" + notes[index].login + "</span> @ <span class=\"url\">" + notes[index].url + "</span> : <span class=\"content\">" + notes[index].content + "</span></span>";

    term.echo("Entry is now : ")
    term.echo(s)
}

function addEntry(title, login, url, pwd, term) {

    var nextFreeId = _.max(notes, function(el) {
        return el.id
    }).id + 1

    //very first ID
    if(notes.length == 0) {
        nextFreeId = 1
    }

    newEntry = {
        id: nextFreeId,
        column: -1,
        title: title,
        url: url,
        login: login,
        content: pwd,
        order: -1,
        lastupdate: Date.now()
    };

    oldHash = hash(JSON.stringify(notes));
    oldNotesLength = notes.length;

    notes.push(newEntry);

    saveCipher(oldNotesLength, oldHash, false, term);

    var s = '<span class="entry"><span class="id">(' + newEntry.id + ')</span> <span class="title">' + newEntry.title + "</span> -> <span class=\"login\">" + newEntry.login + "</span> @ <span class=\"url\">" + newEntry.url + "</span> : <span class=\"content\">" + newEntry.content + "</span></span>";

    term.echo("New entry is : ")
    term.echo(s)
}

function genEntry(title, login, url, term) {

    var pwd = generatePassword(15, false, true, true).join('');
    addEntry(title, login, url, pwd, term);
}

function getCipher(_username, _localPasswordHash, _remotePasswordHash, term) {

    url = "./ajax/core.php/" + _username + "/" + _remotePasswordHash + "/do"; //do is just for obfuscation

    $.get(url, function(answer) {
        if (answer.error != undefined && answer.error == true) {
            
            term.echo('Wrong username / remote password (or DB link inactive).');

            isAuth = false;
            remotePassword = "";
            localPassword = "";
        } else {
            try {
                    try {
                        var cipher = answer.data.replace(/!\n/g, '').replace(/\s/g, '');

                        if(answer.data == undefined || answer.data == "" || cipher == undefined || cipher == "")
                        {
                            term.echo("Pull success, 0 entries. Future entries will be encrypted with the provided local password.")
                            notes = [];
                            username = _username;
                            remotePassword = _remotePasswordHash;
                            localPassword = _localPasswordHash;
                            isAuth = true;
                        }
                        else
                        {
                            var plain = CryptoJS.AES.decrypt(cipher, _localPasswordHash, {
                                format: JsonFormatter
                            }).toString(CryptoJS.enc.Utf8);
                            notes = JSON.parse(plain);
                            term.echo("Pull success, retrieved " + notes.length + " entries.");

                            username = _username;
                            remotePassword = _remotePasswordHash;
                            localPassword = _localPasswordHash;
                            isAuth = true;
                        }

                    } catch (e) {
                        term.echo('Can\'t decrypt; Wrong local password.');

                        isAuth = false;
                        remotePassword = "";
                        localPassword = "";

                    }
            } catch (e) {
                term.echo('Wrong username / remote password (or DB link inactive).');

                isAuth = false;
                remotePassword = "";
                localPassword = "";
            }
        }
    });
}

function highlight(terms, baseString) {

    /*
    var signs = ['¢', '°', '§', '~', '¨', '=', '£']

    var i = 1
    var first = true
    _.each(terms, function(term){
        baseString = baseString.replace(new RegExp("("+term+")", 'gim'), ""+signs[i % signs.length]+'$1¬');
        i++
    });

    for(i = 0; i<signs.length; i++)    {
        baseString = baseString.replace(new RegExp(signs[i], 'gim'), '<span class="highlight'+(i+1)+'">');
        console.log("Replacing "+signs[i]+" with "+'<span class="highlight'+(i+1)+'">')
    }
    baseString = baseString.replace(new RegExp('¬', 'gim'), '</span>');
    */
    var i = 1
    _.each(terms, function(term){
        baseString = baseString.replace(new RegExp("("+term+")", 'gim'), '<span class="highlight'+i+'">$1</span>');
        i++
    });

    return baseString
}

function saveCipher(oldNodeLength, oldEntriesHash, force, term) {
    url = "./ajax/core.php/" + username + "/" + remotePassword + "/do"; //do is just for obfuscation

    var raw = JSON.stringify(notes);
    var cipher = CryptoJS.AES.encrypt(raw, localPassword, {
        format: JsonFormatter
    });
    var data = cipher.toString();
    $.post(url, {
        'data': data, 
        'last_hash' : oldEntriesHash,
        'new_hash' : hash(raw),
        'force' : force
    }, function(answer, status, headers, config) {
        if (answer.error != undefined && answer.error == true) {
            if(answer.non_fast_forward == true) {
                term.echo("Cannot push : the server's information is newer than the one being pushed. Please pull (it will remove your non-previously-pushed changes) and retry. Message : <i>Non-fast-forward</i>")
            }
            else
            {
            term.echo('Wrong username / remote password (or DB link inactive).');

                isAuth = false;
                remotePassword = "";
                localPassword = "";
            }
        } else {
            try {
                if (answer.data.indexOf('"ct"') != -1) {
                    var cipher = answer.data;
                    var plain = CryptoJS.AES.decrypt(cipher, localPassword, {
                        format: JsonFormatter
                    }).toString(CryptoJS.enc.Utf8);

                    notes = JSON.parse(plain);
                    term.echo("Push success, went from " + oldNodeLength + " to " + notes.length + " entries.");
                } else {
                    notes = answer.data;
                }
            } catch (e) {
                isAuth = false;
                remotePassword = "";
                localPassword = "";
                $cookies.passwordHash = '';
            }
        }
    });
}

function hash(s) {
    var s2 = CryptoJS.SHA1(s);
    return s2.toString(CryptoJS.enc.Base64);
}

/** Function count the occurrences of substring in a string;
 * @param {String} string   Required. The string;
 * @param {String} subString    Required. The string to search for;
 * @param {Boolean} allowOverlapping    Optional. Default: false;
 * @author Vitim.us http://stackoverflow.com/questions/4009756/how-to-count-string-occurrence-in-string/7924240#7924240
 */
function countOccurrences(string, subString, allowOverlapping) {

    string += "";
    subString += "";
    if (subString.length <= 0) return (string.length + 1);

    var n = 0,
        pos = 0,
        step = allowOverlapping ? 1 : subString.length;

    while (true) {
        pos = string.indexOf(subString, pos);
        if (pos >= 0) {
            ++n;
            pos += step;
        } else break;
    }
    return n;
}

</script>
</body>
